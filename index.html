<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Flea Market</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <h1>Online Flea Market</h1>
</header>

<nav>
    <button onclick="location.href='index.html'">Home</button>
    <button onclick="location.href='upload.html'">Upload</button>
    <button onclick="location.href='rules.html'">Rules</button>
</nav>

<div class="container">
    <div style="margin-bottom:20px;">
        <label>Service Category:</label>
        <select id="serviceFilter" onchange="applyFilters()">
            <option value="">All Services</option>
            <option value="Selling">Selling</option>
            <option value="Renting">Renting</option>
        </select>

        <select id="productFilter" onchange="applyFilters()">
            <option value="All">All</option>
            <option value="Clothes">Clothes</option>
            <option value="Books">Books</option>
            <option value="Cosmetics">Cosmetics</option>
            <option value="Skin Care">Skin Care</option>
            <option value="Accessories">Accessories</option>
            <option value="Others">Others</option>
        </select>

        <div class="sortBox">
            <label><input type="checkbox" id="sortLatest" onchange="applyFilters()"> Latest → Oldest</label>
            <label><input type="checkbox" id="sortCheap" onchange="applyFilters()"> Cheapest → Expensive</label>
        </div>

        <input type="range" id="priceRange" min="2" max="100" value="100" oninput="updatePriceLabel(this.value)">
        <span id="priceValue">RM100</span>
    </div>

    <div id="productsContainer" style="display:flex;flex-wrap:wrap;gap:10px;"></div>
</div>

<script type="module">
import { db } from './firebase.js';
import { collection, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

let productsCache = []; // cache for filtering

// For demonstration, assume currentUser is logged-in seller's name
// Replace this with your authentication logic if available
const currentUser = prompt("Enter your seller name for delete permission:"); 

async function loadProducts() {
    const container = document.getElementById("productsContainer");
    container.innerHTML = "Loading...";
    const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
    const snapshot = await getDocs(q);
    productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    displayItems();
}

function displayItems(serviceFilter = "", productFilter = "All", maxPrice = 100, sortLatest = false, sortCheap = false) {
    const container = document.getElementById("productsContainer");
    container.innerHTML = "";
    if (!productsCache.length) {
        container.innerHTML = "<p>No items found.</p>";
        return;
    }

    let items = [...productsCache];

    // Filters
    if (serviceFilter) items = items.filter(i => i.serviceCategory === serviceFilter);
    if (productFilter !== "All") items = items.filter(i => i.productCategory === productFilter);
    items = items.filter(i => i.price <= maxPrice);

    // Sorting
    if (sortLatest && sortCheap) {
        items.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0) || a.price - b.price);
    } else if (sortLatest) {
        items.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
    } else if (sortCheap) {
        items.sort((a, b) => a.price - b.price);
    }

    // Display
    items.forEach((item, index) => {
        const box = document.createElement("div");
        box.className = "product-box";

        const img = document.createElement("img");
        img.src = item.imageUrl;

        const name = document.createElement("p");
        name.innerHTML = `<strong>Product:</strong> ${item.productName}`;

        const seller = document.createElement("p");
        seller.innerHTML = `<strong>Seller:</strong> ${item.sellerName}`;

        const category = document.createElement("p");
        category.innerHTML = `<strong>Category:</strong> ${item.productCategory}`;

        const price = document.createElement("p");
        price.innerHTML = `<strong>Price:</strong> RM${item.price}`;

        const detailsBtn = document.createElement("button");
        detailsBtn.innerText = "Product Details";
        detailsBtn.onclick = () => {
            localStorage.setItem("selectedItemId", item.id);
            window.location.href = "productDetail.html";
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.innerText = "Delete";
        deleteBtn.style.marginLeft = "5px";

        // Only show delete button for the uploader
        if (item.sellerName === currentUser) {
            deleteBtn.onclick = async () => {
                if (confirm("Delete this item?")) {
                    await deleteDoc(doc(db, "products", item.id));
                    alert("Item deleted.");
                    loadProducts(); // reload
                }
            };
        } else {
            deleteBtn.style.display = "none";
        }

        box.append(img, name, seller, category, price, detailsBtn, deleteBtn);
        container.appendChild(box);
    });
}

function applyFilters(){
    const serviceFilter = document.getElementById("serviceFilter").value;
    const productFilter = document.getElementById("productFilter").value;
    const maxPrice = parseFloat(document.getElementById("priceRange").value);
    const sortLatest = document.getElementById("sortLatest").checked;
    const sortCheap = document.getElementById("sortCheap").checked;

    displayItems(serviceFilter, productFilter, maxPrice, sortLatest, sortCheap);
}

function updatePriceLabel(value){
    document.getElementById("priceValue").innerText = "RM" + value;
    applyFilters();
}

window.onload = loadProducts;
</script>

</body>
</html>










